<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <title>Mapbox GL JS Examples</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.0/mapbox-gl.css' rel='stylesheet'/>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
<style>
    .map-overlay {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        position: absolute;
        width: 25%;
        top: 0;
        left: 0;
        padding: 10px;
    }

    .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .map-overlay h2 {
        line-height: 24px;
        display: block;
        margin: 0 0 10px;
    }

    .map-overlay .legend .bar {
        height: 10px;
        width: 100%;
        background: linear-gradient(to right, #fca107, #7f3121);
    }

    .map-overlay input {
        background-color: transparent;
        display: inline-block;
        width: 100%;
        position: relative;
        margin: 0;
        cursor: ew-resize;
    }
</style>

<div id='map'></div>
<div class="map-overlay top">
    <div class="map-overlay-inner">
        <h2>VIIRS Fire 2012 -2018, monthly intervals</h2>
        <label id="startDate">2012-01-01</label>
        <input id="sliderYear" type="range" min="0" max="6" step="1" value="0"/>
        <input id="sliderMonth" type="range" min="0" max="11" step="1" value="0"/>
    </div>
</div>

<script>

    var map = new mapboxgl.Map({
        'container': 'map',
        'zoom': 6,
        'center': [10, 10],
        'style': {
            'version': 8,
            'sources': {
                'carto-dark': {
                    'type': 'raster',
                    'tiles': [
                        "https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
                        "https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
                        "https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
                        "https://d.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"
                    ]
                },
                'nasa_viirs_fire_alerts': {
                    'type': 'vector',
                    'tiles': [
                        "http://54.237.221.136/nasa_viirs_fire_alerts/v202003/dynamic/{z}/{x}/{y}@0.25x.pbf?start_date=2017-01-01&end_date=2017-02-01&high_confidence_only=False&include_attribute=frp__mw"
                    ]
                }

            },
            'layers': [{
                'id': 'carto-dark-layer',
                'type': 'raster',
                'source': 'carto-dark',
                'minzoom': 0,
                'maxzoom': 22
            }, {
                'id': 'viirs-points-agg',
                'type': 'circle',
                'source': 'nasa_viirs_fire_alerts',
                // ST_AsMVT() uses 'default' as layer name
                'source-layer': 'nasa_viirs_fire_alerts',
                'minzoom': 0,
                'maxzoom': 6,
                'paint': {
                    'circle-radius': {
                        'base': 0.5,
                        'stops': [[3, 0.75], [5, 1], [7, 1.5], [8, 1.75], [9, 2], [10, 2.5], [11, 3], [12, 4]]
                    },
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ["to-number", ["get", "frp__mw"]],
                        0,
                        '#FFDA07',
                        2,
                        '#FFCC00',
                        4,
                        '#F76000',
                        8,
                        '#FF0000',
                        16,
                        '#B51212',
                        32,
                        '#000000'
                    ]
                }
            },
                {
                    'id': 'viirs-points',
                    'type': 'circle',
                    'source': 'nasa_viirs_fire_alerts',
                    // ST_AsMVT() uses 'default' as layer name
                    'source-layer': 'nasa_viirs_fire_alerts',
                    'minzoom': 6,
                    'maxzoom': 22,
                    'paint': {
                        'circle-radius': {
                            'base': 0.5,
                            'stops': [[3, 0.75], [5, 1], [7, 1.5], [8, 1.75], [9, 2], [10, 2.5], [11, 3], [12, 4]]
                        },
                        'circle-color': [
                            'interpolate',
                            ['linear'],
                            ["to-number", ["get", "frp__mw"]],
                            0,
                            '#FFDA07',
                            2,
                            '#FFCC00',
                            4,
                            '#F76000',
                            8,
                            '#FF0000',
                            16,
                            '#B51212',
                            32,
                            '#000000'
                        ]
                    }
                }
            ]
        }
    });


    map.addControl(new mapboxgl.NavigationControl());
    // When a click event occurs on a feature in the states layer, open a popup at the
    // location of the click, with description HTML from its properties.
    map.on('click', 'viirs-points', function (e) {
        console.log(e.features)
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML("<strong>MODIS VIIRS Fire Alerts</strong>" +
                "<p>Latitude: " + e.features[0].properties.latitude + "</p>" +
                "<p>Longitude: " + e.features[0].properties.longitude + "</p>" +
                "<p>Acquisition Date: " + e.features[0].properties.alert__date + "</p>" +
                "<p>Acquisition Time: " + e.features[0].properties.alert__time_utc + "</p>" +
                "<p>Confidence: " + e.features[0].properties.confidence + "</p>" +
                "<p>Brightness - TI4 (K): " + e.features[0].properties.bright_ti4__k + "</p>" +
                "<p>Brightness - TI5 (K): " + e.features[0].properties.bright_ti5__k + "</p>" +
                "<p>Fire Radiative Power (MW): " + e.features[0].properties.frp__mw + "</p>")

            .addTo(map);
    });

    map.on('click', 'viirs-points-agg', function (e) {
        console.log(e.features)
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML("<strong>MODIS VIIRS Fire Alerts</strong>" +
                "<p>Alert Count: " + e.features[0].properties.count + "</p>" +
                "<p>Most frequent date: " + e.features[0].properties.alert__date + "</p>" +
                "<p>Avg Brightness - TI4 (K): " + Math.round(e.features[0].properties.bright_ti4__k, 1) + "</p>" +
                "<p>Avg Brightness - TI5 (K): " + Math.round(e.features[0].properties.bright_ti5__k, 1) + "</p>" +
                "<p>Total Fire Radiative Power (MW): " + e.features[0].properties.frp__mw + "</p>")

            .addTo(map);
    });

    // Change the cursor to a pointer when the mouse is over the states layer.
    map.on('mouseenter', 'viirs-points', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'viirs-points', function () {
        map.getCanvas().style.cursor = '';
    });

    // Set filter to first month of the year
    // 0 = January
    // changeBaseYear(0);

    let updateFires = (monthDiff) => {
        let initalDate = new Date(2012, 0, 1);
        let startDate = new Date(initalDate.setMonth(initalDate.getMonth() + monthDiff));
        let endDate = new Date(startDate.setMonth(startDate.getMonth() + 1));

        let startStr = startDate.toISOString().slice(0, 10);
        let endStr = endDate.toISOString().slice(0, 10);

        let url = "http://54.237.221.136/nasa_viirs_fire_alerts/v202003/dynamic/{z}/{x}/{y}@0.25x.pbf?start_date=" + startStr + "&end_date=" + endStr + "&high_confidence_only=False&include_attribute=frp__mw"

        if (map.getSource('nasa_viirs_fire_alerts')) {
            map.removeLayer('viirs-points');
            map.removeLayer('viirs-points-agg');
            map.removeSource('nasa_viirs_fire_alerts');
        }
        map.addSource('nasa_viirs_fire_alerts', {
            'type': 'vector',
            'tiles': [url]
        });

        map.addLayer({
            'id': 'viirs-points-agg',
            'type': 'circle',
            'source': 'nasa_viirs_fire_alerts',
            // ST_AsMVT() uses 'default' as layer name
            'source-layer': 'default',
            'minzoom': 0,
            'maxzoom': 6,
            'paint': {
                'circle-radius': {
                    'base': 0.5,
                    'stops': [[3, 0.75], [5, 1], [7, 1.5], [8, 1.75], [9, 2], [10, 2.5], [11, 3], [12, 4]]
                },
                'circle-color': [
                    'interpolate',
                    ['linear'],
                    ["to-number", ["get", "frp__mw"]],
                    0,
                    '#FFDA07',
                    2,
                    '#FFCC00',
                    4,
                    '#F76000',
                    8,
                    '#FF0000',
                    16,
                    '#B51212',
                    32,
                    '#000000'
                ]
            }
        });
        map.addLayer({
            'id': 'viirs-points',
            'type': 'circle',
            'source': 'nasa_viirs_fire_alerts',
            // ST_AsMVT() uses 'default' as layer name
            'source-layer': 'nase_viirs_fire_alerts',
            'minzoom': 6,
            'maxzoom': 22,
            'paint': {
                'circle-radius': {
                    'base': 0.5,
                    'stops': [[3, 0.75], [5, 1], [7, 1.5], [8, 1.75], [9, 2], [10, 2.5], [11, 3], [12, 4]]
                },
                'circle-color': [
                    'interpolate',
                    ['linear'],
                    ["to-number", ["get", "frp__mw"]],
                    0,
                    '#FFDA07',
                    2,
                    '#FFCC00',
                    4,
                    '#F76000',
                    8,
                    '#FF0000',
                    16,
                    '#B51212',
                    32,
                    '#000000'
                ]
            }
        });
        // Set the label to the year
        document.getElementById('startDate').textContent = startStr;

    }

    document
        .getElementById('sliderYear')
        .addEventListener('input', function (e) {
            let month = document.getElementById('sliderMonth').value;
            let monthDiff = month + parseInt(e.target.value, 10) * 12;
            updateFires(monthDiff)
        });
    document
        .getElementById('sliderMonth')
        .addEventListener('input', function (e) {
            let year = document.getElementById('sliderYear').value;
            let monthDiff = parseInt(e.target.value, 10) + year * 12;
            updateFires(monthDiff)
        });

</script>

</body>
</html>
