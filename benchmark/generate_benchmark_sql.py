import mercantile

zoom = [
    [
        [2, 1, 0],
        [2, 2, 0],
        [2, 3, 0],
        [2, 1, 1],
        [2, 2, 1],
        [2, 3, 1],
        [2, 1, 2],
        [2, 2, 2],
        [2, 3, 2],
    ],
    [
        [3, 3, 2],
        [3, 4, 2],
        [3, 5, 2],
        [3, 3, 3],
        [3, 4, 3],
        [3, 5, 3],
        [3, 3, 4],
        [3, 4, 4],
        [3, 5, 4],
    ],
    [
        [4, 8, 6],
        [4, 9, 6],
        [4, 10, 6],
        [4, 8, 7],
        [4, 9, 7],
        [4, 10, 7],
        [4, 8, 8],
        [4, 9, 8],
        [4, 10, 8],
    ],
    [
        [5, 16, 14],
        [5, 17, 14],
        [5, 18, 14],
        [5, 16, 15],
        [5, 17, 15],
        [5, 18, 15],
        [5, 16, 16],
        [5, 17, 16],
        [5, 18, 16],
    ],
    [
        [6, 33, 29],
        [6, 34, 29],
        [6, 35, 29],
        [6, 33, 30],
        [6, 34, 30],
        [6, 35, 30],
        [6, 33, 31],
        [6, 34, 31],
        [6, 35, 31],
    ],
    [
        [7, 67, 60],
        [7, 68, 60],
        [7, 69, 60],
        [7, 67, 61],
        [7, 68, 61],
        [7, 69, 61],
        [7, 67, 62],
        [7, 68, 62],
        [7, 69, 62],
    ],
    [
        [8, 136, 121],
        [8, 137, 121],
        [8, 138, 121],
        [8, 136, 122],
        [8, 137, 122],
        [8, 138, 122],
        [8, 136, 123],
        [8, 137, 123],
        [8, 138, 123],
    ],
    [
        [9, 274, 243],
        [9, 275, 243],
        [9, 276, 243],
        [9, 274, 244],
        [9, 275, 244],
        [9, 276, 244],
        [9, 274, 245],
        [9, 275, 245],
        [9, 276, 245],
    ],
]

dates = [
    ["2012-01-01", "2012-01-07"],
    ["2013-01-01", "2013-01-07"],
    ["2014-01-01", "2014-01-07"],
    ["2015-01-01", "2015-01-07"],
    ["2016-01-01", "2016-01-07"],
    ["2017-01-01", "2017-01-07"],
    ["2018-01-01", "2018-01-07"],
    ["2012-04-01", "2012-04-07"],
    ["2013-04-01", "2013-04-07"],
    ["2014-04-01", "2014-04-07"],
    ["2015-04-01", "2015-04-07"],
    ["2016-04-01", "2016-04-07"],
    ["2017-04-01", "2017-04-07"],
    ["2018-04-01", "2018-04-07"],
    ["2012-07-01", "2012-04-07"],
    ["2013-07-01", "2013-07-07"],
    ["2014-07-01", "2014-07-07"],
    ["2015-04-01", "2015-07-07"],
    ["2016-07-01", "2016-07-07"],
    ["2017-07-01", "2017-01-07"],
    ["2018-07-01", "2018-07-07"],
    ["2012-11-01", "2012-11-07"],
    ["2013-11-01", "2013-11-07"],
    ["2014-11-01", "2014-11-07"],
    ["2015-11-01", "2015-11-07"],
    ["2016-11-01", "2016-11-07"],
    ["2017-11-01", "2017-11-07"],
    ["2018-11-01", "2018-11-07"],
]

for tiles in zoom:
    with open(f"benchmark-zoom{tiles[0][0]}.sql", "w") as f:
        for tile in tiles:
            for d in dates:
                z, x, y = tile
                start_date, end_date = d
                f.write(f"-- Tile {z}/{x}/{y}")
                f.write(f"-- Dates {start_date} - {end_date}\n")

                left, bottom, right, top = mercantile.xy_bounds(
                    tile[0], tile[1], tile[2]
                )
                f.write(
                    f"""WITH bounds AS ( SELECT ST_MakeEnvelope({left}, {bottom}, {right}, {top}, 3857) AS geom), mvtgeom AS ( SELECT ST_AsMVTGeom(t.geom_wm, bounds.geom::box2d) AS geom, bright_ti4, bright_ti5 FROM viirs.v20200224 t, bounds WHERE ST_Intersects(t.geom_wm, bounds.geom) AND acq_date BETWEEN '{start_date}'::timestamp AND '{end_date}'::timestamp), mvtgroup AS ( SELECT geom, count(*) as count, sum(bright_ti4) as bright_ti4, sum(bright_ti5) as bright_ti5 FROM mvtgeom GROUP BY geom ) SELECT ST_AsMVT(mvtgroup.*) FROM mvtgroup;\n"""
                )
